<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Kelas - SDN Karangsari</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <!-- Tambahkan library PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Logo Styles - DIPERBAIKI agar seragam */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .logo-fallback {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-school {
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .logo-subtitle {
            font-size: 10px;
            color: #e2e8f0;
            opacity: 0.8;
        }

        /* Header Logo */
        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

        .header-logo-fallback {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        /* Role Badge */
        .role-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card h3 {
            color: #718096;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-card .subvalue {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover, .btn-success:hover, .btn-warning:hover, .btn-info:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .table-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }

        .table-header p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 14px;
        }

        /* Siswa Table */
        .siswa-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .siswa-table th {
            background: #f7fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            font-size: 14px;
        }

        .siswa-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .siswa-table tr:hover {
            background: #f7fafc;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #c6f6d5;
            color: #276749;
        }

        .status-inactive {
            background: #fed7d7;
            color: #c53030;
        }

        /* Student Info */
        .student-name {
            font-weight: 600;
            color: #2d3748;
        }

        .student-id {
            font-size: 12px;
            color: #718096;
            font-family: monospace;
        }

        /* Action Buttons in Table */
        .action-cell {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #4299e1;
            color: white;
        }

        .btn-delete {
            background: #e53e3e;
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Permission Info */
        .permission-info {
            background: #f0fff4;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #9ae6b4;
            font-size: 12px;
            color: #276749;
        }

        /* Kelas Badge */
        .kelas-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            background: #e9d8fd;
            color: #553c9a;
            display: inline-block;
            text-align: center;
            min-width: 60px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-primary, .btn-success, .btn-warning, .btn-info, .btn-secondary {
                width: 100%;
                text-align: center;
            }
            
            .action-cell {
                flex-direction: column;
            }
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Animation Styles */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-container">
                <!-- LOGO SIDEBAR - DIPERBAIKI agar seragam -->
                <img src="../assets/images/logo.png" alt="Logo SDN Karangsari" class="logo-icon"
                     onerror="this.style.display='none'; document.getElementById('sidebarLogoFallback').style.display='flex';">
                <div id="sidebarLogoFallback" class="logo-fallback" style="display: none;">
                    üéì
                </div>
                <div class="logo-text">
                    <div class="logo-school">SDN KARANGSARI</div>
                    <div class="logo-subtitle">MANAJEMEN KELAS</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="manajemen-kelas.html" class="nav-item active">
                    <span>üë•</span>
                    <span>Manajemen Kelas</span>
                </a>
                <a href="input-nilai.html" class="nav-item">
                    <span>üìù</span>
                    <span>Input Nilai</span>
                </a>
                <a href="absensi.html" class="nav-item">
                    <span>‚úÖ</span>
                    <span>Absensi</span>
                </a>
                <a href="laporan.html" class="nav-item">
                    <span>üìã</span>
                    <span>Laporan</span>
                </a>
                <button onclick="logout()" class="nav-item logout">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <!-- HEADER LOGO - DIPERBAIKI agar seragam -->
                <div class="header-logo">
                    <img src="../assets/images/logo.png" alt="Logo SDN Karangsari" class="header-logo-icon"
                         onerror="this.style.display='none'; document.getElementById('headerLogoFallback').style.display='flex';">
                    <div id="headerLogoFallback" class="header-logo-fallback" style="display: none;">
                        üéì
                    </div>
                    <h1>Manajemen Kelas</h1>
                </div>
                <div class="user-info">
                    <span id="userName"></span>
                    <span id="userRole" class="role-badge"></span>
                </div>
            </header>
            
            <div class="dashboard-content">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Siswa</h3>
                        <div class="value" id="totalSiswa">0</div>
                        <div class="subvalue" id="infoKelas">Pilih kelas</div>
                    </div>
                    <div class="stat-card">
                        <h3>Siswa Aktif</h3>
                        <div class="value" id="siswaAktif">0</div>
                        <div class="subvalue">Status aktif</div>
                    </div>
                    <div class="stat-card">
                        <h3>Laki-laki</h3>
                        <div class="value" id="siswaLaki">0</div>
                        <div class="subvalue">Jenis kelamin</div>
                    </div>
                    <div class="stat-card">
                        <h3>Perempuan</h3>
                        <div class="value" id="siswaPerempuan">0</div>
                        <div class="subvalue">Jenis kelamin</div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label class="filter-label">Kelas</label>
                            <select id="filterKelas" class="filter-select" onchange="loadDataSiswa()">
                                <option value="">Semua Kelas</option>
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select id="filterStatus" class="filter-select" onchange="loadDataSiswa()">
                                <option value="all">Semua Status</option>
                                <option value="active">Aktif</option>
                                <option value="inactive">Tidak Aktif</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Cari Siswa</label>
                            <input type="text" id="filterSearch" class="filter-input" placeholder="Nama atau NIS..." onkeyup="filterSiswa()">
                        </div>
                    </div>
                    
                    <!-- Permission Info -->
                    <div class="permission-info" id="permissionInfo" style="display: none;">
                        <strong>Hak Akses:</strong> 
                        <span id="permissionText">Memuat informasi hak akses...</span>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="tambahSiswa()" class="btn-success">
                            <span>‚ûï Tambah Siswa</span>
                        </button>
                        <button onclick="exportDataSiswa()" class="btn-warning">
                            <span>üìä Export Excel</span>
                        </button>
                        <button onclick="exportPDF()" class="btn-info">
                            <span>üìÑ Export PDF</span>
                        </button>
                        <button onclick="printData()" class="btn-secondary">
                            <span>üñ®Ô∏è Print</span>
                        </button>
                    </div>
                </div>

                <!-- Table Siswa -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 id="tableTitle">Data Siswa</h3>
                        <p id="tableDescription">Pilih kelas untuk melihat data siswa</p>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="siswa-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">No</th>
                                    <th style="width: 120px;">NIS</th>
                                    <th>Nama Siswa</th>
                                    <th style="width: 80px;">Kelas</th>
                                    <th style="width: 100px;">Jenis Kelamin</th>
                                    <th style="width: 150px;">TTL</th>
                                    <th style="width: 200px;">Alamat</th>
                                    <th style="width: 100px;">Status</th>
                                    <th style="width: 120px;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswaTableBody">
                                <tr>
                                    <td colspan="9">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üë•</div>
                                            <p>Belum ada data untuk ditampilkan</p>
                                            <small>Pilih kelas terlebih dahulu</small>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Manajemen Kelas Functions
        let currentUser = null;
        let currentData = {
            siswa: [],
            filteredSiswa: []
        };

        // ==================== ROLE-BASED PERMISSIONS ====================
        function checkPermission(action) {
            const user = currentUser;
            
            if (!user) return false;
            
            const permissions = {
                'tambah_siswa': ['Admin', 'Guru Kelas', 'Wali Kelas'],
                'edit_siswa': ['Admin', 'Guru Kelas', 'Wali Kelas'], 
                'hapus_siswa': ['Admin'], // Hanya Admin yang bisa hapus
                'export_data': ['Admin', 'Guru Kelas', 'Wali Kelas'],
                'print_data': ['Admin', 'Guru Kelas', 'Wali Kelas']
            };
            
            const userRoles = permissions[action] || [];
            const hasPermission = userRoles.includes(user.role);
            
            console.log(`üîê Permission check: ${action} - User: ${user.role} - Allowed: ${hasPermission}`);
            return hasPermission;
        }

        function showPermissionDenied(action) {
            const messages = {
                'hapus_siswa': '‚ùå Hanya Admin yang dapat menghapus data siswa',
                'tambah_siswa': '‚ùå Anda tidak memiliki izin untuk menambah siswa',
                'edit_siswa': '‚ùå Anda tidak memiliki izin untuk mengedit siswa',
                'export_data': '‚ùå Anda tidak memiliki izin untuk export data',
                'print_data': '‚ùå Anda tidak memiliki izin untuk print data'
            };
            
            showNotification(messages[action] || '‚ùå Anda tidak memiliki izin untuk aksi ini', 'error', 4000);
        }

        function updatePermissionInfo() {
            const permissionInfo = document.getElementById('permissionInfo');
            const permissionText = document.getElementById('permissionText');
            
            if (!currentUser) return;
            
            const canAdd = checkPermission('tambah_siswa');
            const canEdit = checkPermission('edit_siswa');
            const canDelete = checkPermission('hapus_siswa');
            const canExport = checkPermission('export_data');
            
            let permissions = [];
            if (canAdd) permissions.push('Tambah');
            if (canEdit) permissions.push('Edit');
            if (canDelete) permissions.push('Hapus');
            if (canExport) permissions.push('Export');
            
            permissionText.textContent = permissions.join(' ‚Ä¢ ');
            permissionInfo.style.display = 'block';
            
            // Tampilkan info role khusus
            if (currentUser.role === 'Admin') {
                permissionInfo.innerHTML = `<strong>üõ°Ô∏è Hak Akses Admin:</strong> <span id="permissionText">${permissions.join(' ‚Ä¢ ')}</span>`;
                permissionInfo.style.background = '#fed7d7';
                permissionInfo.style.borderColor = '#feb2b2';
                permissionInfo.style.color = '#c53030';
            } else {
                permissionInfo.innerHTML = `<strong>üë®‚Äçüè´ Hak Akses ${currentUser.role}:</strong> <span id="permissionText">${permissions.join(' ‚Ä¢ ')}</span>`;
            }
        }

        async function loadManajemenKelas() {
            console.log('üë• Loading manajemen kelas...');
            
            currentUser = checkAuth();
            if (!currentUser) {
                console.log('‚ùå User not authenticated, redirecting...');
                window.location.href = '../index.html';
                return;
            }
            
            // Display user info dengan role
            document.getElementById('userName').textContent = currentUser.nama;
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Tampilkan info permissions
            console.log('üîê User permissions:', {
                canAdd: checkPermission('tambah_siswa'),
                canEdit: checkPermission('edit_siswa'), 
                canDelete: checkPermission('hapus_siswa'),
                canExport: checkPermission('export_data')
            });
            
            // Update permission info display
            updatePermissionInfo();
            
            // Setup filter berdasarkan role
            setupFilterByRole();
            
            console.log('‚úÖ Manajemen kelas loaded');
        }

        function setupFilterByRole() {
            const filterKelas = document.getElementById('filterKelas');
            
            if (currentUser.role === 'Admin') {
                // Admin bisa melihat semua kelas
                filterKelas.disabled = false;
                filterKelas.style.backgroundColor = '';
                console.log('üõ°Ô∏è Admin - dapat melihat semua kelas');
                
                // Auto load data untuk semua kelas
                setTimeout(() => {
                    loadDataSiswa();
                }, 500);
            } else if (currentUser.role === 'Guru Kelas' && currentUser.kelas_dipegang) {
                const kelasAngka = currentUser.kelas_dipegang.replace('A', '');
                filterKelas.value = kelasAngka;
                filterKelas.disabled = true;
                filterKelas.style.backgroundColor = '#f7fafc';
                console.log('üéØ Guru kelas - auto select class:', kelasAngka);
                
                // Auto load data
                setTimeout(() => {
                    loadDataSiswa();
                }, 500);
            }
        }

        async function loadDataSiswa() {
            const kelas = document.getElementById('filterKelas').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            // Show loading
            const tbody = document.getElementById('siswaTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                            <p>Memuat data siswa...</p>
                        </div>
                    </td>
                </tr>
            `;
            
            try {
                console.log('üìä Loading data siswa...', { kelas, statusFilter });
                
                // Build query berdasarkan filter status dan kelas
                let query = supabase
                    .from('siswa')
                    .select('*')
                    .order('nama_siswa');
                
                // Filter berdasarkan kelas jika dipilih (kecuali untuk Admin yang memilih "Semua Kelas")
                if (kelas) {
                    query = query.eq('kelas', kelas);
                }
                
                if (statusFilter === 'active') {
                    query = query.eq('status', true);
                } else if (statusFilter === 'inactive') {
                    query = query.eq('status', false);
                }
                
                const { data: siswa, error } = await query;
                
                if (error) {
                    console.error('‚ùå Error loading siswa:', error);
                    throw error;
                }
                
                currentData.siswa = siswa || [];
                currentData.filteredSiswa = [...currentData.siswa];
                
                console.log('‚úÖ Siswa loaded:', currentData.siswa.length);
                
                // Update UI
                updateStats();
                displaySiswaTable();
                
                showNotification(`‚úÖ Data ${currentData.siswa.length} siswa berhasil dimuat`, 'success', 2000);
                
            } catch (error) {
                console.error('‚ùå Error loading data siswa:', error);
                showNotification('Gagal memuat data siswa: ' + error.message, 'error', 4000);
                
                // Show error state
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ùå</div>
                                <p>Gagal memuat data siswa</p>
                                <small>${error.message}</small>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function filterSiswa() {
            const searchTerm = document.getElementById('filterSearch').value.toLowerCase();
            
            if (!searchTerm) {
                currentData.filteredSiswa = [...currentData.siswa];
            } else {
                currentData.filteredSiswa = currentData.siswa.filter(siswa => 
                    siswa.nama_siswa.toLowerCase().includes(searchTerm) ||
                    siswa.id_siswa.toLowerCase().includes(searchTerm)
                );
            }
            
            displaySiswaTable();
        }

        function displaySiswaTable() {
            const tbody = document.getElementById('siswaTableBody');
            
            if (!currentData.filteredSiswa || currentData.filteredSiswa.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîç</div>
                                <p>Tidak ada data siswa</p>
                                <small>${currentData.siswa.length === 0 ? 'Belum ada data siswa' : 'Data tidak ditemukan'}</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const canDelete = checkPermission('hapus_siswa');
            
            tbody.innerHTML = currentData.filteredSiswa.map((siswa, index) => {
                const deleteButton = canDelete ? 
                    `<button onclick="hapusSiswa('${siswa.id_siswa}', '${siswa.nama_siswa}')" class="btn-small btn-delete">
                        üóëÔ∏è Hapus
                    </button>` : '';
                
                return `
                    <tr>
                        <td style="text-align: center;">${index + 1}</td>
                        <td>
                            <div class="student-id">${siswa.id_siswa}</div>
                        </td>
                        <td>
                            <div class="student-name">${siswa.nama_siswa}</div>
                        </td>
                        <td style="text-align: center;">
                            <span class="kelas-badge">${siswa.kelas}</span>
                        </td>
                        <td>
                            ${siswa.jk === 'L' ? 'üë¶ Laki-laki' : 'üëß Perempuan'}
                        </td>
                        <td>
                            <div style="font-size: 14px;">${siswa.ttl || '-'}</div>
                        </td>
                        <td>
                            <div style="font-size: 14px;">${siswa.alamat || '-'}</div>
                        </td>
                        <td>
                            <span class="status-badge ${siswa.status ? 'status-active' : 'status-inactive'}">
                                ${siswa.status ? 'Aktif' : 'Non-Aktif'}
                            </span>
                        </td>
                        <td>
                            <div class="action-cell">
                                <button onclick="editSiswa('${siswa.id_siswa}')" class="btn-small btn-edit">
                                    ‚úèÔ∏è Edit
                                </button>
                                ${deleteButton}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateTableInfo();
        }

        function updateStats() {
            const kelas = document.getElementById('filterKelas').value;
            const totalSiswa = currentData.siswa.length;
            const siswaAktif = currentData.siswa.filter(s => s.status).length;
            const siswaLaki = currentData.siswa.filter(s => s.jk === 'L').length;
            const siswaPerempuan = currentData.siswa.filter(s => s.jk === 'P').length;
            
            document.getElementById('totalSiswa').textContent = totalSiswa;
            
            if (kelas) {
                document.getElementById('infoKelas').textContent = `Kelas ${kelas}`;
            } else {
                document.getElementById('infoKelas').textContent = `Semua Kelas`;
            }
            
            document.getElementById('siswaAktif').textContent = siswaAktif;
            document.getElementById('siswaLaki').textContent = siswaLaki;
            document.getElementById('siswaPerempuan').textContent = siswaPerempuan;
        }

        function updateTableInfo() {
            const kelas = document.getElementById('filterKelas').value;
            const searchTerm = document.getElementById('filterSearch').value;
            
            let title = kelas ? `Data Siswa Kelas ${kelas}` : `Data Semua Siswa`;
            let description = `${currentData.filteredSiswa.length} siswa`;
            
            if (searchTerm) {
                description += ` (difilter: "${searchTerm}")`;
            }
            
            document.getElementById('tableTitle').textContent = title;
            document.getElementById('tableDescription').textContent = description;
        }

        // ==================== FITUR TAMBAH SISWA ====================
        async function tambahSiswa() {
            if (!checkPermission('tambah_siswa')) {
                showPermissionDenied('tambah_siswa');
                return;
            }

            const result = await showTambahSiswaForm();
            if (!result) return;

            const { id_siswa, nama, kelas, jk, ttl, alamat } = result;

            try {
                // Cek apakah ID siswa sudah ada
                const { data: existingSiswa, error: checkError } = await supabase
                    .from('siswa')
                    .select('id_siswa')
                    .eq('id_siswa', id_siswa)
                    .single();

                if (existingSiswa) {
                    showNotification('‚ùå ID Siswa sudah terdaftar di sistem', 'error', 4000);
                    return;
                }

                // Prepare data siswa
                const siswaData = {
                    id_siswa: id_siswa,
                    nama_siswa: nama,
                    kelas: kelas,
                    jk: jk,
                    ttl: ttl || '',
                    alamat: alamat || '',
                    status: true,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                // Insert ke database
                const { data, error } = await supabase
                    .from('siswa')
                    .insert([siswaData]);

                if (error) {
                    if (error.code === '23505') {
                        showNotification('‚ùå ID Siswa sudah terdaftar di sistem', 'error', 4000);
                        return;
                    }
                    throw error;
                }

                showNotification(`‚úÖ Siswa ${nama} berhasil ditambahkan ke Kelas ${kelas}`, 'success', 4000);
                
                // Refresh data
                loadDataSiswa();
                
            } catch (error) {
                console.error('Error tambah siswa:', error);
                showNotification('‚ùå Gagal menambah siswa: ' + error.message, 'error', 5000);
            }
        }

        function showTambahSiswaForm() {
            return new Promise((resolve) => {
                // Hapus form sebelumnya jika ada
                const existingForm = document.getElementById('tambah-siswa-form');
                if (existingForm) {
                    existingForm.remove();
                }

                // Buat overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                // Buat form
                const form = document.createElement('div');
                form.id = 'tambah-siswa-form';
                form.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    max-width: 500px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                `;

                form.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: #2d3748;">‚ûï Tambah Siswa Baru</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">ID Siswa (NIS) *</label>
                            <input type="text" id="inputIDSiswa" class="form-input" 
                                   placeholder="Masukkan ID Siswa/NIS" required>
                            <small style="color: #718096; font-size: 12px;">ID Siswa akan digunakan sebagai NIS</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Nama Lengkap *</label>
                            <input type="text" id="inputNama" class="form-input" 
                                   placeholder="Masukkan nama lengkap" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kelas *</label>
                            <select id="inputKelas" class="form-select">
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Jenis Kelamin *</label>
                            <select id="inputJK" class="form-select">
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">TTL (Tempat, Tanggal Lahir)</label>
                            <input type="text" id="inputTTL" class="form-input" 
                                   placeholder="Contoh: Jakarta, 15 Januari 2015">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Alamat</label>
                            <textarea id="inputAlamat" class="form-textarea" 
                                      placeholder="Masukkan alamat lengkap"></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button id="cancelTambah" style="padding: 10px 20px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer;">
                            Batal
                        </button>
                        <button id="submitTambah" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer;">
                            Simpan Siswa
                        </button>
                    </div>
                `;

                overlay.appendChild(form);
                document.body.appendChild(overlay);

                // Event listeners
                document.getElementById('submitTambah').addEventListener('click', () => {
                    const id_siswa = document.getElementById('inputIDSiswa').value.trim();
                    const nama = document.getElementById('inputNama').value.trim();
                    const kelas = document.getElementById('inputKelas').value;
                    const jk = document.getElementById('inputJK').value;
                    const ttl = document.getElementById('inputTTL').value.trim();
                    const alamat = document.getElementById('inputAlamat').value.trim();

                    if (!id_siswa || !nama) {
                        showNotification('‚ùå ID Siswa dan Nama harus diisi', 'error', 3000);
                        return;
                    }

                    overlay.remove();
                    resolve({ id_siswa, nama, kelas, jk, ttl, alamat });
                });

                document.getElementById('cancelTambah').addEventListener('click', () => {
                    overlay.remove();
                    resolve(null);
                });

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(null);
                    }
                });
            });
        }

        // ==================== FITUR EDIT SISWA ====================
        async function editSiswa(siswaId) {
            if (!checkPermission('edit_siswa')) {
                showPermissionDenied('edit_siswa');
                return;
            }

            const siswa = currentData.siswa.find(s => s.id_siswa === siswaId);
            if (!siswa) {
                showNotification('‚ùå Data siswa tidak ditemukan', 'error', 3000);
                return;
            }

            const result = await showEditSiswaForm(siswa);
            if (!result) return;

            const { nama, kelas, jk, ttl, alamat, status } = result;

            try {
                const updateData = {
                    nama_siswa: nama,
                    kelas: kelas,
                    jk: jk,
                    ttl: ttl || '',
                    alamat: alamat || '',
                    status: status,
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('siswa')
                    .update(updateData)
                    .eq('id_siswa', siswaId);

                if (error) throw error;

                showNotification(`‚úÖ Data siswa ${nama} berhasil diperbarui`, 'success', 4000);
                loadDataSiswa();

            } catch (error) {
                console.error('Error edit siswa:', error);
                showNotification('‚ùå Gagal mengedit siswa: ' + error.message, 'error', 5000);
            }
        }

        function showEditSiswaForm(siswa) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                const form = document.createElement('div');
                form.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    max-width: 500px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                `;

                form.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: #2d3748;">‚úèÔ∏è Edit Data Siswa</h3>
                    
                    <div style="margin-bottom: 15px; padding: 10px; background: #f7fafc; border-radius: 6px;">
                        <strong>ID Siswa (NIS):</strong> ${siswa.id_siswa}
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">Nama Lengkap *</label>
                            <input type="text" id="editNama" class="form-input" value="${siswa.nama_siswa}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Kelas *</label>
                            <select id="editKelas" class="form-select">
                                <option value="1" ${siswa.kelas === '1' ? 'selected' : ''}>Kelas 1</option>
                                <option value="2" ${siswa.kelas === '2' ? 'selected' : ''}>Kelas 2</option>
                                <option value="3" ${siswa.kelas === '3' ? 'selected' : ''}>Kelas 3</option>
                                <option value="4" ${siswa.kelas === '4' ? 'selected' : ''}>Kelas 4</option>
                                <option value="5" ${siswa.kelas === '5' ? 'selected' : ''}>Kelas 5</option>
                                <option value="6" ${siswa.kelas === '6' ? 'selected' : ''}>Kelas 6</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Jenis Kelamin *</label>
                            <select id="editJK" class="form-select">
                                <option value="L" ${siswa.jk === 'L' ? 'selected' : ''}>Laki-laki</option>
                                <option value="P" ${siswa.jk === 'P' ? 'selected' : ''}>Perempuan</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">TTL (Tempat, Tanggal Lahir)</label>
                            <input type="text" id="editTTL" class="form-input" value="${siswa.ttl || ''}" 
                                   placeholder="Contoh: Jakarta, 15 Januari 2015">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Alamat</label>
                            <textarea id="editAlamat" class="form-textarea">${siswa.alamat || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="editStatus" class="form-select">
                                <option value="true" ${siswa.status ? 'selected' : ''}>Aktif</option>
                                <option value="false" ${!siswa.status ? 'selected' : ''}>Non-Aktif</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button id="cancelEdit" style="padding: 10px 20px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer;">
                            Batal
                        </button>
                        <button id="submitEdit" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer;">
                            Update Data
                        </button>
                    </div>
                `;

                overlay.appendChild(form);
                document.body.appendChild(overlay);

                document.getElementById('submitEdit').addEventListener('click', () => {
                    const nama = document.getElementById('editNama').value.trim();
                    const kelas = document.getElementById('editKelas').value;
                    const jk = document.getElementById('editJK').value;
                    const ttl = document.getElementById('editTTL').value.trim();
                    const alamat = document.getElementById('editAlamat').value.trim();
                    const status = document.getElementById('editStatus').value === 'true';

                    if (!nama) {
                        showNotification('‚ùå Nama harus diisi', 'error', 3000);
                        return;
                    }

                    overlay.remove();
                    resolve({ nama, kelas, jk, ttl, alamat, status });
                });

                document.getElementById('cancelEdit').addEventListener('click', () => {
                    overlay.remove();
                    resolve(null);
                });

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(null);
                    }
                });
            });
        }

        // ==================== FITUR HAPUS SISWA ====================
        async function hapusSiswa(siswaId, namaSiswa) {
            if (!checkPermission('hapus_siswa')) {
                showPermissionDenied('hapus_siswa');
                return;
            }

            const confirmed = await showConfirm(
                'Hapus Siswa',
                `Apakah Anda yakin ingin menghapus siswa "${namaSiswa}"?\n\nTindakan ini tidak dapat dibatalkan.`,
                'Hapus',
                'Batal'
            );

            if (!confirmed) return;

            try {
                const { error } = await supabase
                    .from('siswa')
                    .delete()
                    .eq('id_siswa', siswaId);

                if (error) throw error;

                showNotification(`‚úÖ Siswa ${namaSiswa} berhasil dihapus`, 'success', 4000);
                loadDataSiswa();

            } catch (error) {
                console.error('Error hapus siswa:', error);
                showNotification('‚ùå Gagal menghapus siswa: ' + error.message, 'error', 5000);
            }
        }

        // ==================== FITUR EXPORT EXCEL ====================
        async function exportDataSiswa() {
            if (!checkPermission('export_data')) {
                showPermissionDenied('export_data');
                return;
            }

            const kelas = document.getElementById('filterKelas').value;

            try {
                showNotification('üì§ Menyiapkan data siswa untuk export...', 'info', 2000);

                // Ambil data siswa
                let query = supabase
                    .from('siswa')
                    .select('*')
                    .order('nama_siswa');

                if (kelas) {
                    query = query.eq('kelas', kelas);
                }

                const { data: siswa, error } = await query;

                if (error) throw error;

                if (!siswa || siswa.length === 0) {
                    showNotification('‚ùå Tidak ada data siswa untuk diexport', 'error', 3000);
                    return;
                }

                // Format CSV
                let csvContent = 'Data Siswa' + (kelas ? ' - Kelas ' + kelas : '') + '\n\n';
                csvContent += 'No,ID Siswa (NIS),Nama Siswa,Kelas,Jenis Kelamin,TTL,Alamat,Status\n';
                
                siswa.forEach((siswa, index) => {
                    const row = [
                        index + 1,
                        siswa.id_siswa,
                        `"${siswa.nama_siswa}"`,
                        siswa.kelas,
                        siswa.jk === 'L' ? 'Laki-laki' : 'Perempuan',
                        `"${siswa.ttl || ''}"`,
                        `"${siswa.alamat || ''}"`,
                        siswa.status ? 'Aktif' : 'Non-Aktif'
                    ];
                    csvContent += row.join(',') + '\n';
                });

                // Download file
                downloadCSV(csvContent, `data_siswa${kelas ? '_kelas_' + kelas : ''}.csv`);
                showNotification('‚úÖ Data siswa berhasil diexport!', 'success', 3000);

            } catch (error) {
                console.error('Export error:', error);
                showNotification('‚ùå Gagal mengexport data: ' + error.message, 'error', 4000);
            }
        }

        // ==================== FITUR EXPORT PDF ====================
        async function exportPDF() {
            if (!checkPermission('export_data')) {
                showPermissionDenied('export_data');
                return;
            }

            const kelas = document.getElementById('filterKelas').value;

            try {
                showNotification('üìÑ Membuat PDF data siswa...', 'info', 2000);

                // Ambil data siswa
                let query = supabase
                    .from('siswa')
                    .select('*')
                    .eq('status', true)
                    .order('nama_siswa');

                if (kelas) {
                    query = query.eq('kelas', kelas);
                }

                const { data: siswa, error } = await query;

                if (error) throw error;

                if (!siswa || siswa.length === 0) {
                    showNotification('‚ùå Tidak ada data siswa untuk PDF', 'error', 3000);
                    return;
                }

                // Buat PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(16);
                doc.setTextColor(40, 40, 40);
                doc.text(`DATA SISWA${kelas ? ' KELAS ' + kelas : ''}`, 105, 15, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`SDN Karangsari - Dicetak pada: ${new Date().toLocaleDateString('id-ID')}`, 105, 22, { align: 'center' });
                
                // Prepare data untuk tabel
                const tableData = siswa.map((siswa, index) => [
                    index + 1,
                    siswa.id_siswa,
                    siswa.nama_siswa,
                    siswa.kelas,
                    siswa.jk === 'L' ? 'Laki-laki' : 'Perempuan',
                    siswa.ttl || '-',
                    siswa.alamat || '-'
                ]);

                // Buat tabel
                doc.autoTable({
                    startY: 30,
                    head: [['No', 'ID Siswa (NIS)', 'Nama Siswa', 'Kelas', 'Jenis Kelamin', 'TTL', 'Alamat']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [102, 126, 234] }
                });

                // Simpan PDF
                doc.save(`data_siswa${kelas ? '_kelas_' + kelas : ''}.pdf`);
                showNotification('‚úÖ PDF berhasil dibuat!', 'success', 3000);

            } catch (error) {
                console.error('PDF export error:', error);
                showNotification('‚ùå Gagal membuat PDF: ' + error.message, 'error', 4000);
            }
        }

        // ==================== FITUR PRINT ====================
        function printData() {
            if (!checkPermission('print_data')) {
                showPermissionDenied('print_data');
                return;
            }

            const kelas = document.getElementById('filterKelas').value;

            // Buat window print
            const printWindow = window.open('', '_blank');
            const tableHTML = document.querySelector('.table-container').innerHTML;
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Data Siswa${kelas ? ' Kelas ' + kelas : ''}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                color: #333;
                            }
                            .print-header { 
                                text-align: center; 
                                margin-bottom: 20px;
                                border-bottom: 2px solid #333;
                                padding-bottom: 10px;
                            }
                            .print-header h1 { 
                                margin: 0; 
                                color: #2d3748;
                                font-size: 24px;
                            }
                            .print-header h3 { 
                                margin: 5px 0; 
                                color: #4a5568;
                                font-size: 16px;
                            }
                            .print-info {
                                margin-bottom: 20px;
                                padding: 10px;
                                background: #f7fafc;
                                border-radius: 5px;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin-top: 10px;
                                font-size: 12px;
                            }
                            th, td { 
                                border: 1px solid #ddd; 
                                padding: 8px; 
                                text-align: left; 
                            }
                            th { 
                                background-color: #f5f5f5; 
                                font-weight: bold;
                            }
                            tr:nth-child(even) { 
                                background-color: #f9f9f9; 
                            }
                            .kelas-badge {
                                padding: 4px 8px;
                                border-radius: 4px;
                                font-size: 11px;
                                font-weight: 600;
                                background: #e9d8fd;
                                color: #553c9a;
                                display: inline-block;
                                text-align: center;
                                min-width: 50px;
                            }
                            .action-buttons { 
                                margin-top: 20px; 
                                text-align: center;
                            }
                            .btn-print { 
                                padding: 10px 20px; 
                                background: #667eea; 
                                color: white; 
                                border: none; 
                                border-radius: 5px; 
                                cursor: pointer;
                                margin: 5px;
                            }
                            .btn-close { 
                                padding: 10px 20px; 
                                background: #e53e3e; 
                                color: white; 
                                border: none; 
                                border-radius: 5px; 
                                cursor: pointer;
                                margin: 5px;
                            }
                            @media print {
                                .action-buttons { display: none; }
                                body { margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-header">
                            <h1>DATA SISWA${kelas ? ' KELAS ' + kelas : ''}</h1>
                            <h3>SDN Karangsari</h3>
                            <p>Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                        </div>
                        <div class="print-info">
                            <strong>Total Siswa:</strong> ${currentData.siswa.length} | 
                            <strong>Aktif:</strong> ${currentData.siswa.filter(s => s.status).length} | 
                            <strong>Laki-laki:</strong> ${currentData.siswa.filter(s => s.jk === 'L').length} | 
                            <strong>Perempuan:</strong> ${currentData.siswa.filter(s => s.jk === 'P').length}
                        </div>
                        ${tableHTML}
                        <div class="action-buttons">
                            <button onclick="window.print()" class="btn-print">üñ®Ô∏è Print</button>
                            <button onclick="window.close()" class="btn-close">‚ùå Tutup</button>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Custom Notification System
        function showNotification(message, type = 'info', duration = 4000) {
            // Hapus notifikasi sebelumnya jika ada
            const existingNotification = document.getElementById('custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Buat element notifikasi
            const notification = document.createElement('div');
            notification.id = 'custom-notification';
            
            // Set warna berdasarkan type
            const colors = {
                success: '#48bb78',
                error: '#e53e3e',
                warning: '#ed8936',
                info: '#4299e1'
            };
            
            // Tambahkan icon berdasarkan type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">${icons[type]}</span>
                    <span>${message}</span>
                </div>
            `;
            
            // Set styles
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                maxWidth: '400px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                animation: 'slideIn 0.3s ease',
                fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                cursor: 'pointer',
                background: colors[type] || colors.info
            });
            
            // Tambahkan ke body
            document.body.appendChild(notification);
            
            // Click to close
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            });
            
            // Auto-hide jika duration > 0
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
            
            return notification;
        }

        // Custom Confirm Dialog
        function showConfirm(title, message, confirmText = 'Ya', cancelText = 'Tidak') {
            return new Promise((resolve) => {
                // Hapus confirm dialog sebelumnya jika ada
                const existingConfirm = document.getElementById('custom-confirm-dialog');
                if (existingConfirm) {
                    existingConfirm.remove();
                }
                
                // Buat overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                // Buat dialog
                const dialog = document.createElement('div');
                dialog.id = 'custom-confirm-dialog';
                dialog.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    max-width: 400px;
                    width: 90%;
                    animation: fadeIn 0.3s ease;
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 12px 0; color: #2d3748; font-size: 18px;">${title}</h3>
                    <p style="margin: 0 0 20px 0; color: #4a5568; line-height: 1.5; white-space: pre-line;">${message}</p>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="confirm-cancel" style="padding: 10px 20px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ${cancelText}
                        </button>
                        <button id="confirm-ok" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ${confirmText}
                        </button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Event listeners
                document.getElementById('confirm-ok').addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                document.getElementById('confirm-cancel').addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                });
                
                // Tambahkan CSS animations
                if (!document.getElementById('confirm-styles')) {
                    const style = document.createElement('style');
                    style.id = 'confirm-styles';
                    style.textContent = `
                        @keyframes fadeIn {
                            from { opacity: 0; transform: scale(0.9); }
                            to { opacity: 1; transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            });
        }

        function logout() {
            console.log('üö™ Logging out...');
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '../index.html';
        }

        // Load manajemen kelas when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Manajemen Kelas page loaded');
            loadManajemenKelas();
        });
    </script>
</body>
</html>
