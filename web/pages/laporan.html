<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan & Analytics - SDN Karangsari</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <!-- Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Logo Styles */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-school {
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .logo-subtitle {
            font-size: 10px;
            color: #e2e8f0;
            opacity: 0.8;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Tabs Navigation */
        .tabs-container {
            background: white;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-btn:hover:not(.active) {
            color: #4a5568;
            background: #edf2f7;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card h3 {
            color: #718096;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-card .subvalue {
            font-size: 14px;
            color: #718096;
        }

        /* Chart Containers */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .chart-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 25px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }

        .table-header p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 14px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f7fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover, .btn-success:hover, .btn-warning:hover, .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Badges */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: #c6f6d5;
            color: #276749;
        }

        .badge-warning {
            background: #feebc8;
            color: #744210;
        }

        .badge-danger {
            background: #fed7d7;
            color: #c53030;
        }

        .badge-info {
            background: #bee3f8;
            color: #2c5aa0;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Notification Styles */
        #custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                flex-direction: column;
            }
            
            .tab-btn {
                text-align: center;
                border-bottom: 1px solid #e2e8f0;
                border-left: 3px solid transparent;
            }
            
            .tab-btn.active {
                border-left-color: #667eea;
                border-bottom-color: #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-container">
                <div class="logo-icon">üìä</div>
                <div class="logo-text">
                    <div class="logo-school">SDN KARANGSARI</div>
                    <div class="logo-subtitle">MANAJEMEN KELAS</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="manajemen-kelas.html" class="nav-item">
                    <span>üë•</span>
                    <span>Manajemen Kelas</span>
                </a>
                <a href="input-nilai.html" class="nav-item">
                    <span>üìù</span>
                    <span>Input Nilai</span>
                </a>
                <a href="absensi.html" class="nav-item">
                    <span>‚úÖ</span>
                    <span>Absensi</span>
                </a>
                <a href="laporan.html" class="nav-item active">
                    <span>üìã</span>
                    <span>Laporan</span>
                </a>
                <button onclick="logout()" class="nav-item logout">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <h1>Laporan & Analytics</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <span id="userRole" class="role-badge"></span>
                </div>
            </header>
            
            <div class="dashboard-content">
                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label class="filter-label">Kelas</label>
                            <select id="filterKelas" class="filter-select">
                                <option value="all">Semua Kelas</option>
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Bulan</label>
                            <select id="filterBulan" class="filter-select">
                                <option value="all">Semua Bulan</option>
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Tahun</label>
                            <select id="filterTahun" class="filter-select">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Mata Pelajaran</label>
                            <select id="filterMapel" class="filter-select">
                                <option value="all">Semua Mapel</option>
                                <!-- Options akan di-load via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="loadLaporan()" class="btn-primary" id="btnLoadLaporan">
                            <span id="btnLoadText">üìä Muat Laporan</span>
                            <span id="btnLoadLoading" class="loading-spinner" style="display: none;"></span>
                        </button>
                        <button onclick="exportLaporan()" class="btn-success">
                            üì§ Export PDF
                        </button>
                        <button onclick="resetFilter()" class="btn-warning">
                            üîÑ Reset Filter
                        </button>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" onclick="showTab('overview')">üìà Overview</button>
                        <button class="tab-btn" onclick="showTab('presensi')">‚úÖ Rekap Presensi</button>
                        <button class="tab-btn" onclick="showTab('nilai')">üìä Rekap Nilai</button>
                        <button class="tab-btn" onclick="showTab('analytics')">üîç Analytics</button>
                    </div>

                    <!-- Tab: Overview -->
                    <div id="tab-overview" class="tab-content active">
                        <!-- Key Metrics -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Siswa</h3>
                                <div class="value" id="totalSiswa">0</div>
                                <div class="subvalue" id="infoKelas">Semua Kelas</div>
                            </div>
                            <div class="stat-card">
                                <h3>Rata-rata Kehadiran</h3>
                                <div class="value" id="rataKehadiran">0%</div>
                                <div class="subvalue" id="infoBulan">Bulan ini</div>
                            </div>
                            <div class="stat-card">
                                <h3>Rata-rata Nilai</h3>
                                <div class="value" id="rataNilai">0.0</div>
                                <div class="subvalue" id="infoMapel">Semua Mapel</div>
                            </div>
                            <div class="stat-card">
                                <h3>Siswa Perlu Perhatian</h3>
                                <div class="value" id="siswaPerhatian">0</div>
                                <div class="subvalue">Nilai & Presensi rendah</div>
                            </div>
                        </div>

                        <!-- Charts Grid -->
                        <div class="chart-grid">
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Trend Kehadiran Bulanan</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartKehadiran"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Distribusi Nilai</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartDistribusiNilai"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Perbandingan Kelas</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartPerbandinganKelas"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Top Performers</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartTopPerformers"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Rekap Presensi -->
                    <div id="tab-presensi" class="tab-content">
                        <div class="table-container">
                            <div class="table-header">
                                <div>
                                    <h3>Rekap Presensi Siswa</h3>
                                    <p id="presensiDescription">Data kehadiran berdasarkan filter yang dipilih</p>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Nama Siswa</th>
                                            <th>Kelas</th>
                                            <th>Hadir</th>
                                            <th>Izin</th>
                                            <th>Sakit</th>
                                            <th>Alpha</th>
                                            <th>Persentase</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="presensiTableBody">
                                        <tr>
                                            <td colspan="9">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">‚úÖ</div>
                                                    <p>Belum ada data presensi</p>
                                                    <small>Pilih filter dan klik "Muat Laporan"</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Rekap Nilai -->
                    <div id="tab-nilai" class="tab-content">
                        <div class="table-container">
                            <div class="table-header">
                                <div>
                                    <h3>Rekap Nilai Akademik</h3>
                                    <p id="nilaiDescription">Data nilai berdasarkan filter yang dipilih</p>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Nama Siswa</th>
                                            <th>Kelas</th>
                                            <th>Matematika</th>
                                            <th>B Indonesia</th>
                                            <th>IPA</th>
                                            <th>IPS</th>
                                            <th>Rata-rata</th>
                                            <th>Ranking</th>
                                        </tr>
                                    </thead>
                                    <tbody id="nilaiTableBody">
                                        <tr>
                                            <td colspan="9">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">üìä</div>
                                                    <p>Belum ada data nilai</p>
                                                    <small>Pilih filter dan klik "Muat Laporan"</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Analytics -->
                    <div id="tab-analytics" class="tab-content">
                        <div class="chart-grid">
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Korelasi Kehadiran & Nilai</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartKorelasi"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Trend Perkembangan</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartTrend"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3>Analisis Siswa Perlu Perhatian</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nama Siswa</th>
                                            <th>Kelas</th>
                                            <th>Kehadiran</th>
                                            <th>Rata-rata Nilai</th>
                                            <th>Area Improvement</th>
                                            <th>Rekomendasi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analyticsTableBody">
                                        <tr>
                                            <td colspan="6">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">üîç</div>
                                                    <p>Belum ada data analisis</p>
                                                    <small>Pilih filter dan klik "Muat Laporan"</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Laporan & Analytics Functions
        let currentUser = null;
        let currentCharts = {};
        let currentData = {
            presensi: [],
            nilai: [],
            siswa: [],
            analytics: []
        };

        // Chart colors
        const CHART_COLORS = {
            primary: '#667eea',
            success: '#48bb78',
            warning: '#ed8936',
            danger: '#f56565',
            info: '#4299e1',
            secondary: '#a0aec0'
        };

        async function loadLaporanPage() {
            console.log('üìä Loading laporan system...');
            
            currentUser = checkAuth();
            if (!currentUser) {
                console.log('‚ùå User not authenticated, redirecting...');
                window.location.href = '../index.html';
                return;
            }
            
            console.log('‚úÖ User authenticated:', currentUser);
            
            // Display user info
            document.getElementById('userName').textContent = currentUser.nama;
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Setup filter berdasarkan role
            setupFilterByRole();
            
            // Load mata pelajaran
            loadMataPelajaran();
            
            // Set default values
            const now = new Date();
            document.getElementById('filterBulan').value = now.getMonth() + 1;
            document.getElementById('filterTahun').value = now.getFullYear();
            
            // Auto-load data
            setTimeout(() => {
                loadLaporan();
            }, 1000);
        }

        function setupFilterByRole() {
            const filterKelas = document.getElementById('filterKelas');
            
            if (currentUser.role === 'Guru Kelas' && currentUser.kelas_dipegang) {
                const kelasAngka = currentUser.kelas_dipegang.replace('A', '');
                filterKelas.value = kelasAngka;
                filterKelas.disabled = true;
                filterKelas.style.backgroundColor = '#f7fafc';
                console.log('üéØ Guru kelas - auto select class:', kelasAngka);
            }
        }

        function loadMataPelajaran() {
            const mataPelajaran = [
                'Matematika', 'Bahasa Indonesia', 'IPA', 'IPS', 'PKN', 
                'Bahasa Jawa', 'SBDP', 'PJOK', 'PAI'
            ];
            
            const selectMapel = document.getElementById('filterMapel');
            selectMapel.innerHTML = '<option value="all">Semua Mapel</option>' +
                mataPelajaran.map(mapel => 
                    `<option value="${mapel}">${mapel}</option>`
                ).join('');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Refresh charts if needed
            if (currentCharts[tabName]) {
                setTimeout(() => {
                    Object.values(currentCharts[tabName]).forEach(chart => {
                        chart.resize();
                    });
                }, 100);
            }
        }

        async function loadLaporan() {
            const kelas = document.getElementById('filterKelas').value;
            const bulan = document.getElementById('filterBulan').value;
            const tahun = document.getElementById('filterTahun').value;
            const mapel = document.getElementById('filterMapel').value;
            
            // Show loading
            const btnLoad = document.getElementById('btnLoadLaporan');
            const btnLoadText = document.getElementById('btnLoadText');
            const btnLoadLoading = document.getElementById('btnLoadLoading');
            
            btnLoad.disabled = true;
            btnLoadText.style.display = 'none';
            btnLoadLoading.style.display = 'inline-block';
            
            try {
                console.log('üìä Loading laporan...', { kelas, bulan, tahun, mapel });
                
                // Load all data
                await Promise.all([
                    loadDataPresensi(kelas, bulan, tahun),
                    loadDataNilai(kelas, mapel, tahun),
                    loadDataSiswa(kelas),
                    loadDataAnalytics(kelas, bulan, tahun, mapel)
                ]);
                
                // Update UI
                updateOverview();
                updatePresensiTab();
                updateNilaiTab();
                updateAnalyticsTab();
                
                // Initialize charts
                initializeCharts();
                
                showNotification('‚úÖ Laporan berhasil dimuat', 'success', 2000);
                
            } catch (error) {
                console.error('‚ùå Error loading laporan:', error);
                showNotification('Gagal memuat laporan: ' + error.message, 'error', 4000);
            } finally {
                // Hide loading
                btnLoad.disabled = false;
                btnLoadText.style.display = 'inline-block';
                btnLoadLoading.style.display = 'none';
            }
        }

        async function loadDataPresensi(kelas, bulan, tahun) {
            try {
                let query = supabase.from('absensi').select('*');
                
                if (kelas !== 'all') {
                    query = query.eq('kelas', kelas);
                }
                
                if (bulan !== 'all') {
                    const startDate = `${tahun}-${bulan.padStart(2, '0')}-01`;
                    const endDate = `${tahun}-${bulan.padStart(2, '0')}-31`;
                    query = query.gte('tanggal', startDate).lte('tanggal', endDate);
                } else {
                    query = query.like('tanggal', `${tahun}-%`);
                }
                
                const { data: absensi, error } = await query;
                
                if (error) throw error;
                
                currentData.presensi = absensi || [];
                console.log('‚úÖ Presensi data loaded:', currentData.presensi.length);
                
            } catch (error) {
                console.error('‚ùå Error loading presensi:', error);
                currentData.presensi = [];
            }
        }

        async function loadDataNilai(kelas, mapel, tahun) {
            try {
                let query = supabase.from('nilai').select('*');
                
                if (kelas !== 'all') {
                    query = query.eq('kelas', kelas);
                }
                
                if (mapel !== 'all') {
                    // This would need mapping from mapel name to mapel_id
                    // For now, we'll use a simple approach
                    query = query.eq('mapel_id', mapel.substring(0, 2).toUpperCase());
                }
                
                const { data: nilai, error } = await query;
                
                if (error) throw error;
                
                currentData.nilai = nilai || [];
                console.log('‚úÖ Nilai data loaded:', currentData.nilai.length);
                
            } catch (error) {
                console.error('‚ùå Error loading nilai:', error);
                currentData.nilai = [];
            }
        }

        async function loadDataSiswa(kelas) {
            try {
                let query = supabase.from('siswa').select('*').eq('status', true);
                
                if (kelas !== 'all') {
                    query = query.eq('kelas', kelas);
                }
                
                const { data: siswa, error } = await query;
                
                if (error) throw error;
                
                currentData.siswa = siswa || [];
                console.log('‚úÖ Siswa data loaded:', currentData.siswa.length);
                
            } catch (error) {
                console.error('‚ùå Error loading siswa:', error);
                currentData.siswa = [];
            }
        }

        async function loadDataAnalytics(kelas, bulan, tahun, mapel) {
            // This would combine data from multiple sources for analytics
            // For now, we'll create mock analytics data
            try {
                currentData.analytics = generateMockAnalytics();
                console.log('‚úÖ Analytics data loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading analytics:', error);
                currentData.analytics = [];
            }
        }

        function updateOverview() {
            const totalSiswa = currentData.siswa.length;
            const rataKehadiran = calculateRataKehadiran();
            const rataNilai = calculateRataNilai();
            const siswaPerhatian = calculateSiswaPerhatian();
            
            document.getElementById('totalSiswa').textContent = totalSiswa;
            document.getElementById('rataKehadiran').textContent = `${rataKehadiran}%`;
            document.getElementById('rataNilai').textContent = rataNilai.toFixed(1);
            document.getElementById('siswaPerhatian').textContent = siswaPerhatian;
            
            // Update info texts
            const kelas = document.getElementById('filterKelas').value;
            const bulan = document.getElementById('filterBulan').value;
            const mapel = document.getElementById('filterMapel').value;
            
            document.getElementById('infoKelas').textContent = kelas === 'all' ? 'Semua Kelas' : `Kelas ${kelas}`;
            document.getElementById('infoBulan').textContent = bulan === 'all' ? 'Tahun ini' : `Bulan ${getNamaBulan(bulan)}`;
            document.getElementById('infoMapel').textContent = mapel === 'all' ? 'Semua Mapel' : mapel;
        }

        function updatePresensiTab() {
            const tbody = document.getElementById('presensiTableBody');
            const presensiRekap = calculatePresensiRekap();
            
            if (presensiRekap.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚úÖ</div>
                                <p>Tidak ada data presensi</p>
                                <small>Data tidak ditemukan untuk filter yang dipilih</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = presensiRekap.map((siswa, index) => {
                const persentase = siswa.total > 0 ? Math.round((siswa.hadir / siswa.total) * 100) : 0;
                const status = getStatusKehadiran(persentase);
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${siswa.nama}</strong></td>
                        <td>Kelas ${siswa.kelas}</td>
                        <td>${siswa.hadir}</td>
                        <td>${siswa.izin}</td>
                        <td>${siswa.sakit}</td>
                        <td>${siswa.alpha}</td>
                        <td><strong>${persentase}%</strong></td>
                        <td><span class="badge ${status.class}">${status.text}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Update description
            const kelas = document.getElementById('filterKelas').value;
            const bulan = document.getElementById('filterBulan').value;
            document.getElementById('presensiDescription').textContent = 
                `Rekap presensi ${kelas === 'all' ? 'semua kelas' : `Kelas ${kelas}`} 
                 untuk ${bulan === 'all' ? 'tahun ini' : `bulan ${getNamaBulan(bulan)}`}`;
        }

        function updateNilaiTab() {
            const tbody = document.getElementById('nilaiTableBody');
            const nilaiRekap = calculateNilaiRekap();
            
            if (nilaiRekap.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <p>Tidak ada data nilai</p>
                                <small>Data tidak ditemukan untuk filter yang dipilih</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by average and add ranking
            nilaiRekap.sort((a, b) => b.rataRata - a.rataRata);
            
            tbody.innerHTML = nilaiRekap.map((siswa, index) => {
                const ranking = index + 1;
                const rankingClass = ranking <= 3 ? 'badge-success' : 
                                   ranking <= 10 ? 'badge-info' : 'badge-secondary';
                
                return `
                    <tr>
                        <td>${ranking}</td>
                        <td><strong>${siswa.nama}</strong></td>
                        <td>Kelas ${siswa.kelas}</td>
                        <td>${siswa.matematika || '-'}</td>
                        <td>${siswa.bindo || '-'}</td>
                        <td>${siswa.ipa || '-'}</td>
                        <td>${siswa.ips || '-'}</td>
                        <td><strong>${siswa.rataRata.toFixed(1)}</strong></td>
                        <td><span class="badge ${rankingClass}">#${ranking}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Update description
            const kelas = document.getElementById('filterKelas').value;
            const mapel = document.getElementById('filterMapel').value;
            document.getElementById('nilaiDescription').textContent = 
                `Rekap nilai ${mapel === 'all' ? 'semua mata pelajaran' : mapel} 
                 untuk ${kelas === 'all' ? 'semua kelas' : `Kelas ${kelas}`}`;
        }

        function updateAnalyticsTab() {
            const tbody = document.getElementById('analyticsTableBody');
            const analyticsData = currentData.analytics;
            
            if (analyticsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîç</div>
                                <p>Tidak ada data analisis</p>
                                <small>Data tidak ditemukan untuk filter yang dipilih</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = analyticsData.map(siswa => {
                return `
                    <tr>
                        <td><strong>${siswa.nama}</strong></td>
                        <td>Kelas ${siswa.kelas}</td>
                        <td>${siswa.kehadiran}%</td>
                        <td>${siswa.rataNilai.toFixed(1)}</td>
                        <td>${siswa.areaImprovement.join(', ')}</td>
                        <td>${siswa.rekomendasi}</td>
                    </tr>
                `;
            }).join('');
        }

        function initializeCharts() {
            // Destroy existing charts
            Object.values(currentCharts).forEach(tabCharts => {
                Object.values(tabCharts).forEach(chart => {
                    chart.destroy();
                });
            });
            
            currentCharts = {
                overview: {},
                analytics: {}
            };
            
            // Chart 1: Trend Kehadiran
            const ctx1 = document.getElementById('chartKehadiran').getContext('2d');
            currentCharts.overview.kehadiran = new Chart(ctx1, {
                type: 'line',
                data: generateKehadiranData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
            
            // Chart 2: Distribusi Nilai
            const ctx2 = document.getElementById('chartDistribusiNilai').getContext('2d');
            currentCharts.overview.distribusi = new Chart(ctx2, {
                type: 'bar',
                data: generateDistribusiNilaiData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Chart 3: Perbandingan Kelas
            const ctx3 = document.getElementById('chartPerbandinganKelas').getContext('2d');
            currentCharts.overview.perbandingan = new Chart(ctx3, {
                type: 'radar',
                data: generatePerbandinganData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Chart 4: Top Performers
            const ctx4 = document.getElementById('chartTopPerformers').getContext('2d');
            currentCharts.overview.topPerformers = new Chart(ctx4, {
                type: 'doughnut',
                data: generateTopPerformersData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
            
            // Analytics Charts
            const ctx5 = document.getElementById('chartKorelasi').getContext('2d');
            currentCharts.analytics.korelasi = new Chart(ctx5, {
                type: 'scatter',
                data: generateKorelasiData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            const ctx6 = document.getElementById('chartTrend').getContext('2d');
            currentCharts.analytics.trend = new Chart(ctx6, {
                type: 'line',
                data: generateTrendData(),
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // Data calculation functions
        function calculateRataKehadiran() {
            if (currentData.presensi.length === 0) return 0;
            
            const totalHadir = currentData.presensi.filter(a => a.status === 'H').length;
            const totalRecords = currentData.presensi.length;
            
            return totalRecords > 0 ? Math.round((totalHadir / totalRecords) * 100) : 0;
        }

        function calculateRataNilai() {
            if (currentData.nilai.length === 0) return 0;
            
            const totalNilai = currentData.nilai.reduce((sum, nilai) => sum + (parseFloat(nilai.nilai) || 0), 0);
            return totalNilai / currentData.nilai.length;
        }

        function calculateSiswaPerhatian() {
            // Simple logic: students with attendance < 80% and average grade < 70
            return Math.floor(Math.random() * 5) + 1; // Mock data
        }

        function calculatePresensiRekap() {
            const rekap = {};
            
            currentData.presensi.forEach(absensi => {
                if (!rekap[absensi.siswa_id]) {
                    rekap[absensi.siswa_id] = {
                        nama: `Siswa ${absensi.siswa_id}`,
                        kelas: absensi.kelas,
                        hadir: 0,
                        izin: 0,
                        sakit: 0,
                        alpha: 0,
                        total: 0
                    };
                }
                
                rekap[absensi.siswa_id][absensi.status.toLowerCase()]++;
                rekap[absensi.siswa_id].total++;
            });
            
            // Add student names from siswa data
            currentData.siswa.forEach(siswa => {
                if (rekap[siswa.id_siswa]) {
                    rekap[siswa.id_siswa].nama = siswa.nama_siswa;
                }
            });
            
            return Object.values(rekap);
        }

        function calculateNilaiRekap() {
            const rekap = {};
            
            currentData.nilai.forEach(nilai => {
                if (!rekap[nilai.siswa_id]) {
                    rekap[nilai.siswa_id] = {
                        nama: `Siswa ${nilai.siswa_id}`,
                        kelas: nilai.kelas,
                        matematika: null,
                        bindo: null,
                        ipa: null,
                        ips: null,
                        totalNilai: 0,
                        totalMapel: 0,
                        rataRata: 0
                    };
                }
                
                // Map subjects (simplified)
                const mapel = nilai.mapel_id;
                if (mapel.includes('MTK') || mapel.includes('M1')) {
                    rekap[nilai.siswa_id].matematika = parseFloat(nilai.nilai);
                } else if (mapel.includes('BINDO') || mapel.includes('M2')) {
                    rekap[nilai.siswa_id].bindo = parseFloat(nilai.nilai);
                } else if (mapel.includes('IPA') || mapel.includes('M8')) {
                    rekap[nilai.siswa_id].ipa = parseFloat(nilai.nilai);
                } else if (mapel.includes('IPS')) {
                    rekap[nilai.siswa_id].ips = parseFloat(nilai.nilai);
                }
                
                // Calculate average
                const nilaiNum = parseFloat(nilai.nilai);
                if (!isNaN(nilaiNum)) {
                    rekap[nilai.siswa_id].totalNilai += nilaiNum;
                    rekap[nilai.siswa_id].totalMapel++;
                }
            });
            
            // Calculate averages and add student names
            Object.values(rekap).forEach(siswa => {
                if (siswa.totalMapel > 0) {
                    siswa.rataRata = siswa.totalNilai / siswa.totalMapel;
                }
                
                // Add student name from siswa data
                const siswaData = currentData.siswa.find(s => s.id_siswa === Object.keys(rekap).find(key => rekap[key] === siswa));
                if (siswaData) {
                    siswa.nama = siswaData.nama_siswa;
                }
            });
            
            return Object.values(rekap);
        }

        // Chart data generation functions
        function generateKehadiranData() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            return {
                labels: months.slice(0, 6),
                datasets: [{
                    label: 'Persentase Kehadiran',
                    data: [85, 88, 82, 90, 87, 92],
                    borderColor: CHART_COLORS.success,
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };
        }

        function generateDistribusiNilaiData() {
            return {
                labels: ['0-50', '51-60', '61-70', '71-80', '81-90', '91-100'],
                datasets: [{
                    label: 'Jumlah Siswa',
                    data: [2, 5, 12, 18, 15, 8],
                    backgroundColor: CHART_COLORS.primary,
                    borderColor: CHART_COLORS.primary,
                    borderWidth: 1
                }]
            };
        }

        function generatePerbandinganData() {
            return {
                labels: ['Kehadiran', 'Nilai MTK', 'Nilai BINDO', 'Nilai IPA', 'Nilai IPS', 'Rata-rata'],
                datasets: [
                    {
                        label: 'Kelas 1',
                        data: [85, 78, 82, 75, 80, 79],
                        borderColor: CHART_COLORS.primary,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)'
                    },
                    {
                        label: 'Kelas 2',
                        data: [88, 82, 85, 78, 83, 82],
                        borderColor: CHART_COLORS.success,
                        backgroundColor: 'rgba(72, 187, 120, 0.2)'
                    }
                ]
            };
        }

        function generateTopPerformersData() {
            return {
                labels: ['Sangat Baik', 'Baik', 'Cukup', 'Perlu Improvement'],
                datasets: [{
                    data: [15, 25, 40, 20],
                    backgroundColor: [
                        CHART_COLORS.success,
                        CHART_COLORS.info,
                        CHART_COLORS.warning,
                        CHART_COLORS.danger
                    ]
                }]
            };
        }

        function generateKorelasiData() {
            return {
                datasets: [{
                    label: 'Siswa',
                    data: [
                        {x: 85, y: 80}, {x: 92, y: 88}, {x: 78, y: 75},
                        {x: 65, y: 62}, {x: 88, y: 85}, {x: 95, y: 92}
                    ],
                    backgroundColor: CHART_COLORS.primary
                }]
            };
        }

        function generateTrendData() {
            return {
                labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                datasets: [
                    {
                        label: 'Kehadiran',
                        data: [85, 88, 82, 90],
                        borderColor: CHART_COLORS.success,
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Nilai Rata-rata',
                        data: [75, 78, 82, 85],
                        borderColor: CHART_COLORS.primary,
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }
                ]
            };
        }

        function generateMockAnalytics() {
            return [
                {
                    nama: 'Ahmad Santoso',
                    kelas: '1',
                    kehadiran: 65,
                    rataNilai: 68.5,
                    areaImprovement: ['Matematika', 'Kehadiran'],
                    rekomendasi: 'Perlu bimbingan khusus matematika'
                },
                {
                    nama: 'Siti Rahayu',
                    kelas: '2', 
                    kehadiran: 72,
                    rataNilai: 62.0,
                    areaImprovement: ['Bahasa Indonesia', 'IPA'],
                    rekomendasi: 'Tingkatkan frekuensi belajar'
                }
            ];
        }

        // Utility functions
        function getStatusKehadiran(persentase) {
            if (persentase >= 90) return { class: 'badge-success', text: 'Sangat Baik' };
            if (persentase >= 80) return { class: 'badge-info', text: 'Baik' };
            if (persentase >= 70) return { class: 'badge-warning', text: 'Cukup' };
            return { class: 'badge-danger', text: 'Perlu Perhatian' };
        }

        function getNamaBulan(bulan) {
            const bulanNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            return bulanNames[parseInt(bulan) - 1] || '';
        }

        function exportLaporan() {
            showNotification('üì§ Menyiapkan laporan untuk export...', 'info', 3000);
            // In a real implementation, this would generate PDF reports
        }

        function resetFilter() {
            document.getElementById('filterKelas').value = 'all';
            document.getElementById('filterBulan').value = 'all';
            document.getElementById('filterTahun').value = '2025';
            document.getElementById('filterMapel').value = 'all';
            showNotification('üîÑ Filter telah direset', 'info', 2000);
        }

        // Custom Notification System
        function showNotification(message, type = 'info', duration = 4000) {
            const existingNotification = document.getElementById('custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.id = 'custom-notification';
            
            const colors = {
                success: '#48bb78',
                error: '#e53e3e',
                warning: '#ed8936',
                info: '#4299e1'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: ‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">${icons[type]}</span>
                    <span>${message}</span>
                </div>
            `;
            
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                maxWidth: '400px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                animation: 'slideIn 0.3s ease',
                fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                cursor: 'pointer',
                background: colors[type] || colors.info
            });
            
            document.body.appendChild(notification);
            
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            });
            
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
        }

        function logout() {
            console.log('üö™ Logging out...');
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '../index.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Laporan page loaded');
            loadLaporanPage();
        });
    </script>
</body>
</html>