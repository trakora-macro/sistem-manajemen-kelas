<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Nilai - SDN Karangsari</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        /* Logo Styles */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-school {
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .logo-subtitle {
            font-size: 10px;
            color: #e2e8f0;
            opacity: 0.8;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Pertemuan Selector */
        .pertemuan-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .pertemuan-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .pertemuan-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pertemuan-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover, .btn-secondary:hover, .btn-success:hover, .btn-warning:hover, .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .table-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }

        .table-header p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 14px;
        }

        /* Input Table */
        .input-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .input-table th {
            background: #f7fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            font-size: 14px;
        }

        .input-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .input-table tr:hover {
            background: #f7fafc;
        }

        /* Input Fields */
        .nilai-input {
            width: 80px;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nilai-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .nilai-input.valid {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .nilai-input.invalid {
            border-color: #f56565;
            background: #fff5f5;
        }

        /* Student Info */
        .student-name {
            font-weight: 600;
            color: #2d3748;
        }

        .student-id {
            font-size: 12px;
            color: #718096;
            font-family: monospace;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-card h3 {
            color: #718096;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-card .subvalue {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Komponen Info */
        .komponen-info {
            background: #f0fff4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #9ae6b4;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Notification Styles */
        #custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-primary, .btn-secondary, .btn-success, .btn-warning, .btn-info {
                width: 100%;
                text-align: center;
            }
            
            .pertemuan-selector {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-container">
                <div class="logo-icon">üéì</div>
                <div class="logo-text">
                    <div class="logo-school">SDN KARANGSARI</div>
                    <div class="logo-subtitle">MANAJEMEN KELAS</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="manajemen-kelas.html" class="nav-item">
                    <span>üë•</span>
                    <span>Manajemen Kelas</span>
                </a>
                <a href="input-nilai.html" class="nav-item active">
                    <span>üìù</span>
                    <span>Input Nilai</span>
                </a>
                <a href="absensi.html" class="nav-item">
                    <span>‚úÖ</span>
                    <span>Absensi</span>
                </a>
                <a href="laporan.html" class="nav-item">
                    <span>üìã</span>
                    <span>Laporan</span>
                </a>
                <button onclick="logout()" class="nav-item logout">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <h1>Input Nilai Siswa</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <span id="userRole" class="role-badge"></span>
                </div>
            </header>
            
            <div class="dashboard-content">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Siswa</h3>
                        <div class="value" id="totalSiswa">0</div>
                        <div class="subvalue" id="infoKelas">Pilih kelas</div>
                    </div>
                    <div class="stat-card">
                        <h3>Mata Pelajaran</h3>
                        <div class="value" id="mapelSelected">-</div>
                        <div class="subvalue" id="infoSemester">Semester 1</div>
                    </div>
                    <div class="stat-card">
                        <h3>Komponen Nilai</h3>
                        <div class="value" id="komponenSelected">-</div>
                        <div class="subvalue">Pertemuan: <span id="pertemuanKe">-</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>Progress Input</h3>
                        <div class="value" id="progressInput">0%</div>
                        <div class="subvalue" id="infoProgress">-</div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label class="filter-label">Kelas</label>
                            <select id="filterKelas" class="filter-select">
                                <option value="">Pilih Kelas</option>
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Mata Pelajaran</label>
                            <select id="filterMapel" class="filter-select">
                                <option value="">Pilih Mapel</option>
                                <!-- Options akan di-load via JavaScript -->
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Komponen Nilai</label>
                            <select id="filterKomponen" class="filter-select" onchange="updatePertemuanSelector()">
                                <option value="">Pilih Komponen</option>
                                <!-- Options akan di-load via JavaScript -->
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Semester</label>
                            <select id="filterSemester" class="filter-select">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Pertemuan Selector -->
                    <div id="pertemuanSelector" class="pertemuan-selector" style="display: none;">
                        <div style="font-weight: 600; color: #4a5568;">Pilih Pertemuan:</div>
                        <div id="pertemuanButtons">
                            <!-- Buttons akan di-generate via JavaScript -->
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="loadDataNilai()" class="btn-primary" id="btnLoadData">
                            <span id="btnLoadText">üìä Muat Data Nilai</span>
                            <span id="btnLoadLoading" class="loading-spinner" style="display: none;"></span>
                        </button>
                        <button onclick="simpanSemuaNilai()" class="btn-success" id="btnSimpan" disabled>
                            üíæ Simpan Semua Nilai
                        </button>
                        <button onclick="hitungRataRata()" class="btn-info" id="btnRataRata">
                            üìä Hitung Rata-rata
                        </button>
                        <button onclick="resetForm()" class="btn-secondary">
                            üîÑ Reset Form
                        </button>
                        <button onclick="exportNilai()" class="btn-warning">
                            üì§ Export Nilai
                        </button>
                    </div>
                </div>

                <!-- Progress Info -->
                <div class="komponen-info" id="progressInfo" style="display: none;">
                    <h4 style="margin: 0 0 10px 0; color: #276749;">üìà Progress Input Nilai</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px; color: #4a5568;">
                        <span id="progressText">Mengambil data...</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                </div>

                <!-- Table Input Nilai -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 id="tableTitle">Form Input Nilai</h3>
                        <p id="tableDescription">Pilih kelas, mata pelajaran, dan komponen nilai terlebih dahulu</p>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="input-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">No</th>
                                    <th style="width: 120px;">ID Siswa</th>
                                    <th>Nama Siswa</th>
                                    <th style="width: 100px;">Nilai</th>
                                    <th style="width: 120px;">Status</th>
                                    <th style="width: 150px;">Rata-rata</th>
                                    <th style="width: 120px;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="nilaiTableBody">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">üìù</div>
                                            <p>Belum ada data untuk ditampilkan</p>
                                            <small>Pilih filter di atas dan klik "Muat Data Nilai"</small>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Info Komponen -->
                <div class="komponen-info">
                    <h4 style="margin: 0 0 10px 0; color: #276749;">üìã Sistem Multiple Input Nilai</h4>
                    <div style="font-size: 14px; color: #2d3748;">
                        <div><strong>üéØ Tugas Harian:</strong> 8x pertemuan - Input nilai untuk setiap pertemuan</div>
                        <div><strong>üìö Ulangan Harian:</strong> 5x ulangan - Input nilai per bab pelajaran</div>
                        <div><strong>üìä PTS & PAS:</strong> 1x input - Nilai tengah dan akhir semester</div>
                        <div><strong>‚ú® Fitur:</strong> Rata-rata otomatis, progress tracking, multiple save</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Input Nilai Functions dengan Multiple Pertemuan
        let currentUser = null;
        let currentData = {
            siswa: [],
            komponen: [],
            mapel: [],
            nilaiExisting: {},
            rataRata: {}
        };
        
        let currentPertemuan = 1;
        let currentKomponen = null;

        // Komponen penilaian dengan multiple pertemuan
        const KOMPONEN_NILAI = [
            { id: 'P1', nama: 'Tugas Harian', bobot: 15, max_pertemuan: 8, keterangan: '8x pertemuan' },
            { id: 'P2', nama: 'Ulangan Harian', bobot: 20, max_pertemuan: 5, keterangan: '5x ulangan per bab' },
            { id: 'P3', nama: 'PTS', bobot: 30, max_pertemuan: 1, keterangan: 'Tengah semester' },
            { id: 'P4', nama: 'PAS', bobot: 35, max_pertemuan: 1, keterangan: 'Akhir semester' }
        ];

        // Mata pelajaran default
        const MATA_PELAJARAN = [
            { id: 'M1', nama: 'Matematika', kode: 'MTK' },
            { id: 'M2', nama: 'B Indonesia', kode: 'BINDO' },
            { id: 'M3', nama: 'B Jawa', kode: 'BJAWA' },
            { id: 'M4', nama: 'PKn', kode: 'PKN' },
            { id: 'M5', nama: 'SBDP', kode: 'SBDP' },
            { id: 'M6', nama: 'PAI', kode: 'PAI' },
            { id: 'M7', nama: 'PJOK', kode: 'PJOK' },
            { id: 'M8', nama: 'IPAS', kode: 'IPAS' }
        ];

        async function loadInputNilai() {
            console.log('üìù Loading input nilai...');
            
            currentUser = checkAuth();
            if (!currentUser) {
                console.log('‚ùå User not authenticated, redirecting...');
                window.location.href = '../index.html';
                return;
            }
            
            // Display user info
            document.getElementById('userName').textContent = currentUser.nama;
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Setup filter berdasarkan role
            setupFilterByRole();
            
            // Load komponen dan mapel
            loadKomponenMapel();
        }

        function setupFilterByRole() {
            const filterKelas = document.getElementById('filterKelas');
            
            if (currentUser.role === 'Guru Kelas' && currentUser.kelas_dipegang) {
                const kelasAngka = currentUser.kelas_dipegang.replace('A', '');
                filterKelas.value = kelasAngka;
                filterKelas.disabled = true;
                filterKelas.style.backgroundColor = '#f7fafc';
                console.log('üéØ Guru kelas - auto select class:', kelasAngka);
            }
            
            if (currentUser.role === 'Guru Mapel' && currentUser.mapel_dipegang) {
                console.log('üéØ Guru mapel - mapel:', currentUser.mapel_dipegang);
            }
        }

        function loadKomponenMapel() {
            // Load komponen penilaian
            const selectKomponen = document.getElementById('filterKomponen');
            selectKomponen.innerHTML = '<option value="">Pilih Komponen</option>' +
                KOMPONEN_NILAI.map(k => 
                    `<option value="${k.id}" data-max="${k.max_pertemuan}">${k.nama} (${k.bobot}%) - ${k.keterangan}</option>`
                ).join('');
            
            // Load mata pelajaran
            const selectMapel = document.getElementById('filterMapel');
            let filteredMapel = MATA_PELAJARAN;
            
            if (currentUser.role === 'Guru Mapel' && currentUser.mapel_dipegang) {
                filteredMapel = MATA_PELAJARAN.filter(m => 
                    m.kode === currentUser.mapel_dipegang
                );
            }
            
            selectMapel.innerHTML = '<option value="">Pilih Mapel</option>' +
                filteredMapel.map(m => 
                    `<option value="${m.id}">${m.nama}</option>`
                ).join('');
            
            console.log('‚úÖ Komponen dan mapel loaded');
        }

        function updatePertemuanSelector() {
            const komponenId = document.getElementById('filterKomponen').value;
            const pertemuanSelector = document.getElementById('pertemuanSelector');
            const pertemuanButtons = document.getElementById('pertemuanButtons');
            
            if (!komponenId) {
                pertemuanSelector.style.display = 'none';
                return;
            }
            
            const komponen = KOMPONEN_NILAI.find(k => k.id === komponenId);
            currentKomponen = komponen;
            
            if (komponen.max_pertemuan > 1) {
                pertemuanSelector.style.display = 'flex';
                pertemuanButtons.innerHTML = '';
                
                for (let i = 1; i <= komponen.max_pertemuan; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'pertemuan-btn';
                    btn.textContent = `Pertemuan ${i}`;
                    btn.onclick = () => selectPertemuan(i);
                    pertemuanButtons.appendChild(btn);
                }
                
                // Set pertemuan pertama sebagai aktif
                selectPertemuan(1);
            } else {
                pertemuanSelector.style.display = 'none';
                currentPertemuan = 1;
            }
            
            updateTableInfo();
        }

        function selectPertemuan(pertemuan) {
            currentPertemuan = pertemuan;
            
            // Update UI
            const buttons = document.querySelectorAll('.pertemuan-btn');
            buttons.forEach((btn, index) => {
                if (index + 1 === pertemuan) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            document.getElementById('pertemuanKe').textContent = pertemuan;
            
            // Reload data untuk pertemuan yang dipilih
            if (currentData.siswa.length > 0) {
                loadNilaiForPertemuan();
            }
        }

        async function loadDataNilai() {
            const kelas = document.getElementById('filterKelas').value;
            const mapel = document.getElementById('filterMapel').value;
            const komponen = document.getElementById('filterKomponen').value;
            const semester = document.getElementById('filterSemester').value;
            
            if (!kelas || !mapel || !komponen) {
                showNotification('‚ùå Harap pilih Kelas, Mata Pelajaran, dan Komponen Nilai terlebih dahulu', 'error', 3000);
                return;
            }
            
            // Show loading
            const btnLoad = document.getElementById('btnLoadData');
            const btnLoadText = document.getElementById('btnLoadText');
            const btnLoadLoading = document.getElementById('btnLoadLoading');
            
            btnLoad.disabled = true;
            btnLoadText.style.display = 'none';
            btnLoadLoading.style.display = 'inline-block';
            
            try {
                console.log('üìä Loading data nilai...', { kelas, mapel, komponen, semester });
                
                // 1. Load data siswa
                const { data: siswa, error: errorSiswa } = await supabase
                    .from('siswa')
                    .select('*')
                    .eq('kelas', kelas)
                    .eq('status', true);
                
                if (errorSiswa) throw errorSiswa;
                
                currentData.siswa = siswa || [];
                
                // 2. Load semua nilai untuk komponen ini (semua pertemuan)
                await loadAllNilaiForKomponen(kelas, mapel, komponen, semester);
                
                // Update UI
                updateStats();
                loadNilaiForPertemuan();
                document.getElementById('btnSimpan').disabled = false;
                document.getElementById('progressInfo').style.display = 'block';
                
                showNotification(`‚úÖ Data ${currentData.siswa.length} siswa berhasil dimuat`, 'success', 2000);
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                showNotification('Gagal memuat data: ' + error.message, 'error', 4000);
            } finally {
                // Hide loading
                btnLoad.disabled = false;
                btnLoadText.style.display = 'inline-block';
                btnLoadLoading.style.display = 'none';
            }
        }

        async function loadAllNilaiForKomponen(kelas, mapel, komponen, semester) {
            try {
                const { data: semuaNilai, error } = await supabase
                    .from('nilai')
                    .select('*')
                    .eq('kelas', kelas)
                    .eq('mapel_id', mapel)
                    .eq('komponen_id', komponen)
                    .eq('semester', semester);
                
                if (error) throw error;
                
                // Organize data by siswa_id and pertemuan
                currentData.nilaiExisting = {};
                currentData.rataRata = {};
                
                if (semuaNilai) {
                    semuaNilai.forEach(nilai => {
                        const key = `${nilai.siswa_id}_${nilai.pertemuan_ke || 1}`;
                        currentData.nilaiExisting[key] = nilai;
                        
                        // Calculate average
                        if (!currentData.rataRata[nilai.siswa_id]) {
                            currentData.rataRata[nilai.siswa_id] = {
                                total: 0,
                                count: 0,
                                average: 0
                            };
                        }
                        
                        if (nilai.nilai) {
                            currentData.rataRata[nilai.siswa_id].total += parseFloat(nilai.nilai);
                            currentData.rataRata[nilai.siswa_id].count++;
                            currentData.rataRata[nilai.siswa_id].average = 
                                currentData.rataRata[nilai.siswa_id].total / currentData.rataRata[nilai.siswa_id].count;
                        }
                    });
                }
                
                console.log('‚úÖ All nilai loaded:', {
                    totalRecords: semuaNilai ? semuaNilai.length : 0,
                    uniqueStudents: Object.keys(currentData.rataRata).length
                });
                
            } catch (error) {
                console.error('‚ùå Error loading all nilai:', error);
                throw error;
            }
        }

        function loadNilaiForPertemuan() {
            const tbody = document.getElementById('nilaiTableBody');
            
            if (!currentData.siswa || currentData.siswa.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <p>Tidak ada siswa di kelas ini</p>
                                <small>Silakan pilih kelas lain</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const komponenId = document.getElementById('filterKomponen').value;
            const komponen = KOMPONEN_NILAI.find(k => k.id === komponenId);
            
            tbody.innerHTML = currentData.siswa.map((siswa, index) => {
                const key = `${siswa.id_siswa}_${currentPertemuan}`;
                const existingNilai = currentData.nilaiExisting[key];
                const nilai = existingNilai ? existingNilai.nilai : '';
                const status = existingNilai ? '‚úÖ Sudah diinput' : '‚ùå Belum diinput';
                const statusClass = existingNilai ? 'valid' : '';
                
                const rataRataInfo = currentData.rataRata[siswa.id_siswa];
                const rataRata = rataRataInfo ? rataRataInfo.average.toFixed(1) : '-';
                const jumlahInput = rataRataInfo ? rataRataInfo.count : 0;
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div class="student-id">${siswa.id_siswa}</div>
                        </td>
                        <td>
                            <div class="student-name">${siswa.nama_siswa}</div>
                            <div style="font-size: 12px; color: #718096;">
                                ${siswa.jk === 'L' ? 'üë¶' : 'üëß'} ${siswa.jk === 'L' ? 'Laki-laki' : 'Perempuan'}
                            </div>
                        </td>
                        <td>
                            <input type="number" 
                                   min="0" 
                                   max="100" 
                                   step="0.1"
                                   value="${nilai}"
                                   class="nilai-input ${statusClass}"
                                   data-siswa-id="${siswa.id_siswa}"
                                   onchange="validateNilai(this)"
                                   placeholder="0-100">
                        </td>
                        <td>
                            <span style="font-size: 12px; font-weight: 500; color: ${existingNilai ? '#38a169' : '#e53e3e'}">
                                ${status}
                            </span>
                            ${existingNilai ? `
                                <br>
                                <small style="color: #718096;">
                                    ${new Date(existingNilai.updated_at).toLocaleDateString('id-ID')}
                                </small>
                            ` : ''}
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #2d3748;">${rataRata}</div>
                            <small style="color: #718096;">${jumlahInput}/${komponen.max_pertemuan} input</small>
                        </td>
                        <td>
                            <button onclick="simpanNilai('${siswa.id_siswa}')" 
                                    class="btn-success" 
                                    style="padding: 6px 12px; font-size: 12px;">
                                üíæ Simpan
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateTableInfo();
            updateProgress();
        }

        function updateTableInfo() {
            const mapelId = document.getElementById('filterMapel').value;
            const mapel = MATA_PELAJARAN.find(m => m.id === mapelId);
            const komponenId = document.getElementById('filterKomponen').value;
            const komponen = KOMPONEN_NILAI.find(k => k.id === komponenId);
            const kelas = document.getElementById('filterKelas').value;
            
            if (mapel && komponen) {
                let title = `Input Nilai ${komponen.nama}`;
                let description = `${mapel.nama} - Kelas ${kelas}`;
                
                if (komponen.max_pertemuan > 1) {
                    title += ` - Pertemuan ${currentPertemuan}`;
                    description += ` (${currentData.siswa.length} siswa)`;
                }
                
                document.getElementById('tableTitle').textContent = title;
                document.getElementById('tableDescription').textContent = description;
            }
        }

        function updateProgress() {
            if (!currentData.siswa || currentData.siswa.length === 0) return;
            
            const totalSiswa = currentData.siswa.length;
            let completed = 0;
            
            currentData.siswa.forEach(siswa => {
                const key = `${siswa.id_siswa}_${currentPertemuan}`;
                if (currentData.nilaiExisting[key]) {
                    completed++;
                }
            });
            
            const percentage = Math.round((completed / totalSiswa) * 100);
            
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = 
                `${completed} dari ${totalSiswa} siswa sudah diinput`;
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
            document.getElementById('progressInput').textContent = `${percentage}%`;
            document.getElementById('infoProgress').textContent = `${completed}/${totalSiswa} selesai`;
        }

        function validateNilai(input) {
            const value = parseFloat(input.value);
            
            if (isNaN(value)) {
                input.classList.remove('valid', 'invalid');
                return;
            }
            
            if (value >= 0 && value <= 100) {
                input.classList.add('valid');
                input.classList.remove('invalid');
            } else {
                input.classList.add('invalid');
                input.classList.remove('valid');
                showNotification('‚ùå Nilai harus antara 0 - 100', 'error', 3000);
                input.value = '';
            }
        }

        async function simpanNilai(siswaId) {
            const input = document.querySelector(`.nilai-input[data-siswa-id="${siswaId}"]`);
            const nilai = parseFloat(input.value);
            
            if (isNaN(nilai) || nilai < 0 || nilai > 100) {
                showNotification('‚ùå Nilai tidak valid. Harap masukkan nilai antara 0-100', 'error', 3000);
                input.focus();
                return;
            }
            
            const kelas = document.getElementById('filterKelas').value;
            const mapelId = document.getElementById('filterMapel').value;
            const komponenId = document.getElementById('filterKomponen').value;
            const semester = document.getElementById('filterSemester').value;
            
            // Show loading state on button
            const saveButton = document.querySelector(`button[onclick="simpanNilai('${siswaId}')"]`);
            const originalText = saveButton.innerHTML;
            const originalBackground = saveButton.style.background;
            saveButton.innerHTML = '‚è≥ Menyimpan...';
            saveButton.disabled = true;
            
            try {
                console.log('üíæ Saving nilai:', { 
                    siswaId, nilai, mapelId, komponenId, semester, 
                    pertemuan: currentPertemuan 
                });
                
                const nilaiData = {
                    siswa_id: siswaId,
                    mapel_id: mapelId,
                    komponen_id: komponenId,
                    pertemuan_ke: currentPertemuan,
                    sub_komponen: `Pertemuan ${currentPertemuan}`,
                    nilai: nilai,
                    kelas: kelas,
                    semester: semester,
                    tanggal: new Date().toISOString().split('T')[0],
                    created_by: currentUser.id_guru,
                    updated_at: new Date().toISOString()
                };
                
                // Cek apakah nilai sudah ada
                const key = `${siswaId}_${currentPertemuan}`;
                const existingNilai = currentData.nilaiExisting[key];
                
                let result;
                let isUpdate = false;
                
                if (existingNilai && existingNilai.id) {
                    // Update existing
                    result = await supabase
                        .from('nilai')
                        .update(nilaiData)
                        .eq('id', existingNilai.id);
                    isUpdate = true;
                } else {
                    // Insert new
                    nilaiData.created_at = new Date().toISOString();
                    result = await supabase
                        .from('nilai')
                        .insert([nilaiData]);
                }
                
                if (result.error) {
                    console.error('‚ùå Database error:', result.error);
                    
                    // Handle specific errors
                    if (result.error.code === '23505') { // Unique violation
                        console.log('‚ö†Ô∏è Data sudah ada, mencoba update...');
                        // Try to update using composite key
                        const updateResult = await supabase
                            .from('nilai')
                            .update(nilaiData)
                            .eq('siswa_id', siswaId)
                            .eq('mapel_id', mapelId)
                            .eq('komponen_id', komponenId)
                            .eq('pertemuan_ke', currentPertemuan)
                            .eq('semester', semester);
                        
                        if (updateResult.error) throw updateResult.error;
                        result = updateResult;
                        isUpdate = true;
                    } else {
                        throw result.error;
                    }
                }
                
                // FIX: Handle null result.data dengan safe check
                let newId;
                if (isUpdate) {
                    newId = existingNilai ? existingNilai.id : null;
                } else {
                    // Safe check untuk result.data[0] - FIXED!
                    newId = result.data && Array.isArray(result.data) && result.data.length > 0 
                        ? result.data[0].id 
                        : `temp_${siswaId}_${Date.now()}`;
                }
                
                // Show success feedback
                const successMessage = `‚úÖ Nilai ${nilai} berhasil disimpan!`;
                console.log(successMessage);
                
                // Update button dengan feedback visual
                saveButton.innerHTML = '‚úÖ Tersimpan';
                saveButton.style.background = '#48bb78';
                input.classList.add('valid');
                
                // Update local data
                currentData.nilaiExisting[key] = { ...nilaiData, id: newId };
                updateProgress();
                
                // Update rata-rata
                await updateRataRata(siswaId);
                
                // Show success notification (akan auto hilang dalam 1.5 detik)
                showNotification(successMessage, 'success', 1500);
                
                // Reset button setelah 2 detik
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.background = originalBackground;
                    saveButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error saving nilai:', error);
                
                // Show error feedback on button
                saveButton.innerHTML = '‚ùå Gagal';
                saveButton.style.background = '#e53e3e';
                
                // Show notification instead of alert (akan auto hilang dalam 3 detik)
                let errorMessage = 'Gagal menyimpan nilai: ';
                if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Koneksi internet bermasalah';
                } else if (error.message.includes('JWT')) {
                    errorMessage += 'Sesi login habis, silakan login kembali';
                } else if (error.message.includes('null') && error.message.includes('0')) {
                    errorMessage += 'Terjadi kesalahan sistem. Data mungkin tidak tersimpan dengan benar.';
                } else {
                    errorMessage += error.message;
                }
                
                showNotification(errorMessage, 'error', 3000);
                
                // Reset button setelah 3 detik
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.background = originalBackground;
                    saveButton.disabled = false;
                }, 3000);
            }
        }

        async function updateRataRata(siswaId) {
            try {
                const kelas = document.getElementById('filterKelas').value;
                const mapelId = document.getElementById('filterMapel').value;
                const komponenId = document.getElementById('filterKomponen').value;
                const semester = document.getElementById('filterSemester').value;
                
                const { data: nilaiSiswa, error } = await supabase
                    .from('nilai')
                    .select('*')
                    .eq('siswa_id', siswaId)
                    .eq('mapel_id', mapelId)
                    .eq('komponen_id', komponenId)
                    .eq('semester', semester);
                
                if (error) {
                    console.error('Error loading nilai for average:', error);
                    return;
                }
                
                if (nilaiSiswa && nilaiSiswa.length > 0) {
                    let total = 0;
                    let count = 0;
                    
                    nilaiSiswa.forEach(n => {
                        if (n.nilai) {
                            total += parseFloat(n.nilai);
                            count++;
                        }
                    });
                    
                    currentData.rataRata[siswaId] = {
                        total: total,
                        count: count,
                        average: total / count
                    };
                    
                    // Update UI
                    loadNilaiForPertemuan();
                }
            } catch (error) {
                console.error('Error in updateRataRata:', error);
            }
        }

        async function simpanSemuaNilai() {
            if (!currentData.siswa || currentData.siswa.length === 0) {
                showNotification('‚ùå Tidak ada data siswa untuk disimpan', 'error', 3000);
                return;
            }
            
            // Gunakan custom confirm
            const userConfirmed = await showConfirm(
                'Simpan Semua Nilai',
                'üíæ Simpan semua nilai yang telah diinput?\n\nSistem akan menyimpan data untuk semua siswa.',
                'Simpan Semua',
                'Batal'
            );
            
            if (!userConfirmed) {
                return;
            }
            
            const btnSimpan = document.getElementById('btnSimpan');
            const originalText = btnSimpan.innerHTML;
            const originalBackground = btnSimpan.style.background;
            
            try {
                btnSimpan.disabled = true;
                btnSimpan.innerHTML = '‚è≥ Menyimpan...';
                btnSimpan.style.background = '#ed8936';
                
                let successCount = 0;
                let errorCount = 0;
                const totalSiswa = currentData.siswa.length;
                
                // Show progress notification
                const progressNotification = showNotification(`‚è≥ Menyimpan data ${totalSiswa} siswa...`, 'info', 0);
                progressNotification.id = 'progress-notification';
                
                // Update progress content
                progressNotification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; width: 300px;">
                        <span style="font-size: 16px;">‚è≥</span>
                        <div style="flex: 1;">
                            <div>Menyimpan data ${totalSiswa} siswa...</div>
                            <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 5px;">
                                <div id="progress-bar-fill" style="height: 100%; background: white; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Simpan satu per satu
                for (let i = 0; i < currentData.siswa.length; i++) {
                    const siswa = currentData.siswa[i];
                    const input = document.querySelector(`.nilai-input[data-siswa-id="${siswa.id_siswa}"]`);
                    
                    if (input && input.value) {
                        try {
                            await simpanNilaiIndividu(siswa.id_siswa);
                            successCount++;
                        } catch (error) {
                            console.error(`‚ùå Gagal menyimpan nilai ${siswa.nama_siswa}:`, error);
                            errorCount++;
                        }
                    }
                    
                    // Update progress bar
                    const progressPercent = Math.round(((i + 1) / totalSiswa) * 100);
                    const progressBar = document.getElementById('progress-bar-fill');
                    if (progressBar) {
                        progressBar.style.width = `${progressPercent}%`;
                    }
                    
                    // Small delay antara penyimpanan
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Remove progress notification
                if (progressNotification.parentNode) {
                    progressNotification.remove();
                }
                
                // Show result notification
                let message, type;
                if (errorCount === 0) {
                    message = `‚úÖ Semua ${successCount} data berhasil disimpan!`;
                    type = 'success';
                } else {
                    message = `‚ö†Ô∏è ${successCount} berhasil, ${errorCount} gagal dari ${totalSiswa} siswa`;
                    type = 'warning';
                }
                
                showNotification(message, type, 4000);
                
                // Refresh data untuk update UI
                await loadDataNilai();
                
            } catch (error) {
                console.error('‚ùå Error in simpanSemuaNilai:', error);
                // Remove progress notification if exists
                const progressNotification = document.getElementById('progress-notification');
                if (progressNotification && progressNotification.parentNode) {
                    progressNotification.remove();
                }
                showNotification('Terjadi kesalahan saat menyimpan semua data', 'error', 4000);
            } finally {
                btnSimpan.disabled = false;
                btnSimpan.innerHTML = originalText;
                btnSimpan.style.background = originalBackground;
            }
        }

        // Fungsi simpan individu untuk bulk save - FIXED!
        async function simpanNilaiIndividu(siswaId) {
            return new Promise(async (resolve, reject) => {
                try {
                    const input = document.querySelector(`.nilai-input[data-siswa-id="${siswaId}"]`);
                    if (!input || !input.value) {
                        resolve(); // Skip jika tidak ada nilai
                        return;
                    }
                    
                    const nilai = parseFloat(input.value);
                    const kelas = document.getElementById('filterKelas').value;
                    const mapelId = document.getElementById('filterMapel').value;
                    const komponenId = document.getElementById('filterKomponen').value;
                    const semester = document.getElementById('filterSemester').value;
                    
                    const nilaiData = {
                        siswa_id: siswaId,
                        mapel_id: mapelId,
                        komponen_id: komponenId,
                        pertemuan_ke: currentPertemuan,
                        sub_komponen: `Pertemuan ${currentPertemuan}`,
                        nilai: nilai,
                        kelas: kelas,
                        semester: semester,
                        tanggal: new Date().toISOString().split('T')[0],
                        created_by: currentUser.id_guru,
                        updated_at: new Date().toISOString()
                    };
                    
                    const key = `${siswaId}_${currentPertemuan}`;
                    const existingNilai = currentData.nilaiExisting[key];
                    
                    let result;
                    let isUpdate = false;
                    
                    if (existingNilai && existingNilai.id) {
                        result = await supabase
                            .from('nilai')
                            .update(nilaiData)
                            .eq('id', existingNilai.id);
                        isUpdate = true;
                    } else {
                        nilaiData.created_at = new Date().toISOString();
                        result = await supabase
                            .from('nilai')
                            .insert([nilaiData]);
                    }
                    
                    if (result.error) {
                        if (result.error.code === '23505') {
                            // Unique violation - try update by composite key
                            const updateResult = await supabase
                                .from('nilai')
                                .update(nilaiData)
                                .eq('siswa_id', siswaId)
                                .eq('mapel_id', mapelId)
                                .eq('komponen_id', komponenId)
                                .eq('pertemuan_ke', currentPertemuan)
                                .eq('semester', semester);
                            if (updateResult.error) throw updateResult.error;
                            result = updateResult;
                            isUpdate = true;
                        } else {
                            throw result.error;
                        }
                    }
                    
                    // Safe update local data - FIXED!
                    let newId;
                    if (isUpdate) {
                        newId = existingNilai ? existingNilai.id : null;
                    } else {
                        // Safe check untuk result.data[0]
                        newId = result.data && Array.isArray(result.data) && result.data.length > 0 
                            ? result.data[0].id 
                            : `temp_${siswaId}_${Date.now()}`;
                    }
                    
                    currentData.nilaiExisting[key] = { 
                        ...nilaiData, 
                        id: newId
                    };
                    
                    resolve();
                    
                } catch (error) {
                    console.error(`‚ùå Error saving nilai for ${siswaId}:`, error);
                    reject(error);
                }
            });
        }

        async function hitungRataRata() {
            const komponenId = document.getElementById('filterKomponen').value;
            const komponen = KOMPONEN_NILAI.find(k => k.id === komponenId);
            
            if (komponen.max_pertemuan <= 1) {
                showNotification('‚ÑπÔ∏è Komponen ini hanya memiliki 1 pertemuan, tidak perlu hitung rata-rata', 'info', 3000);
                return;
            }
            
            showNotification(`üìä Sistem akan menghitung rata-rata otomatis untuk ${komponen.nama}\n\nRata-rata sudah ditampilkan di kolom "Rata-rata" untuk setiap siswa`, 'info', 4000);
        }

        function updateStats() {
            const kelas = document.getElementById('filterKelas').value;
            const mapelId = document.getElementById('filterMapel').value;
            const komponenId = document.getElementById('filterKomponen').value;
            const semester = document.getElementById('filterSemester').value;
            
            const mapel = MATA_PELAJARAN.find(m => m.id === mapelId);
            const komponen = KOMPONEN_NILAI.find(k => k.id === komponenId);
            
            document.getElementById('totalSiswa').textContent = currentData.siswa.length;
            document.getElementById('infoKelas').textContent = `Kelas ${kelas}`;
            document.getElementById('mapelSelected').textContent = mapel ? mapel.nama : '-';
            document.getElementById('infoSemester').textContent = `Semester ${semester}`;
            document.getElementById('komponenSelected').textContent = komponen ? komponen.nama : '-';
        }

        function resetForm() {
            showConfirm(
                'Reset Form Nilai',
                'üîÑ Reset semua input nilai?\n\nSemua perubahan yang belum disimpan akan hilang.',
                'Reset',
                'Batal'
            ).then(confirmed => {
                if (confirmed) {
                    const inputs = document.querySelectorAll('.nilai-input');
                    inputs.forEach(input => {
                        input.value = '';
                        input.classList.remove('valid', 'invalid');
                    });
                    showNotification('üîÑ Form nilai telah direset', 'info', 2000);
                }
            });
        }

        function exportNilai() {
            showNotification('üì§ Fitur export nilai dalam pengembangan\n\nData akan diexport dalam format Excel dengan semua pertemuan', 'info', 4000);
        }

        // Custom Notification System
        function showNotification(message, type = 'info', duration = 4000) {
            // Hapus notifikasi sebelumnya jika ada
            const existingNotification = document.getElementById('custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Buat element notifikasi
            const notification = document.createElement('div');
            notification.id = 'custom-notification';
            
            // Set warna berdasarkan type
            const colors = {
                success: '#48bb78',
                error: '#e53e3e',
                warning: '#ed8936',
                info: '#4299e1'
            };
            
            // Tambahkan icon berdasarkan type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">${icons[type]}</span>
                    <span style="white-space: pre-line;">${message}</span>
                </div>
            `;
            
            // Set styles
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                maxWidth: '400px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                animation: 'slideIn 0.3s ease',
                fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                cursor: 'pointer',
                background: colors[type] || colors.info
            });
            
            // Tambahkan ke body
            document.body.appendChild(notification);
            
            // Click to close
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            });
            
            // Auto-hide jika duration > 0
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
            
            return notification;
        }

        // Custom Confirm Dialog
        function showConfirm(title, message, confirmText = 'Ya', cancelText = 'Tidak') {
            return new Promise((resolve) => {
                // Hapus confirm dialog sebelumnya jika ada
                const existingConfirm = document.getElementById('custom-confirm-dialog');
                if (existingConfirm) {
                    existingConfirm.remove();
                }
                
                // Buat overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                // Buat dialog
                const dialog = document.createElement('div');
                dialog.id = 'custom-confirm-dialog';
                dialog.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    max-width: 400px;
                    width: 90%;
                    animation: fadeIn 0.3s ease;
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 12px 0; color: #2d3748; font-size: 18px;">${title}</h3>
                    <p style="margin: 0 0 20px 0; color: #4a5568; line-height: 1.5; white-space: pre-line;">${message}</p>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="confirm-cancel" style="padding: 10px 20px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ${cancelText}
                        </button>
                        <button id="confirm-ok" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ${confirmText}
                        </button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Event listeners
                document.getElementById('confirm-ok').addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                document.getElementById('confirm-cancel').addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                });
                
                // Tambahkan CSS animations
                if (!document.getElementById('confirm-styles')) {
                    const style = document.createElement('style');
                    style.id = 'confirm-styles';
                    style.textContent = `
                        @keyframes fadeIn {
                            from { opacity: 0; transform: scale(0.9); }
                            to { opacity: 1; transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            });
        }

        function logout() {
            console.log('üö™ Logging out...');
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '../index.html';
        }

        // Load input nilai when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Input Nilai page loaded');
            loadInputNilai();
        });
    </script>
</body>
</html>